'use strict';class BunzLoader{loaded=new Set();loading=new Map();modulePaths={'scripts':'/js/core/scripts.js','state':'/js/core/state.js','cache':'/js/core/cache.js','modal':'/js/ui/modal.js','toast':'/js/ui/toast.js','cookies':'/js/ui/cookies.js','a11y':'/js/ui/a11y.js','errors':'/js/utils/errors.js','forms':'/js/utils/forms.js','templates':'/js/modules/templates.js','components':'/js/modules/components.js','i18n':'/js/modules/i18n.js','webrtc':'/js/modules/webrtc.js','map':'/js/modules/map.js','canvas':'/js/modules/canvas.js','realtime':'/js/modules/realtime.js',};async load(moduleName){if(this.loaded.has(moduleName)){return Promise.resolve();}if(this.loading.has(moduleName)){return this.loading.get(moduleName);}const promise=this.loadScript(moduleName);this.loading.set(moduleName,promise);try{await promise;this.loaded.add(moduleName);this.loading.delete(moduleName);console.log(`✅ Lazy-loaded:${moduleName}`);}catch(error){console.error(`❌ Failed to load:${moduleName}`,error);this.loading.delete(moduleName);throw error;}return promise;}loadScript(moduleName){return new Promise((resolve,reject)=>{const script=document.createElement('script');script.src=this.modulePaths[moduleName]||`/js/modules/${moduleName}.js`;script.defer=true;script.onload=resolve;script.onerror=reject;document.head.appendChild(script);});}isLoaded(moduleName){return this.loaded.has(moduleName);}async loadAll(moduleNames){return Promise.all(moduleNames.map(name=>this.load(name)));}}window.bunzLoader=new BunzLoader();console.log('✅ BUNZ Loader initialized(lazy-loading enabled)');document.addEventListener('DOMContentLoaded',()=>{requestIdleCallback(()=>{bunzLoader.load('scripts');if(document.getElementById('bunz-modal')){bunzLoader.load('modal');}bunzLoader.load('toast');if(!localStorage.getItem('cookie-consent')){bunzLoader.load('cookies');}bunzLoader.load('a11y');if(document.querySelector('form')){bunzLoader.load('forms');}},{timeout:1000});});document.addEventListener('bunz:loaded',()=>{const needsTemplates=document.querySelector('.video-container,.room-page-container,.meeting-page');if(needsTemplates&&!window.bunzTemplates){bunzLoader.load('templates');}});class BunzLifecycle{listeners=new Map();async beforeSwap(target,url){const event=new CustomEvent('bunz:beforeSwap',{detail:{target,url},cancelable:true});document.dispatchEvent(event);if(this.listeners.has(target)){for(const cleanup of this.listeners.get(target)){await cleanup();}this.listeners.delete(target);}return!event.defaultPrevented;}afterSwap(target,url,html){document.dispatchEvent(new CustomEvent('bunz:afterSwap',{detail:{target,url,html}}));}onCleanup(target,fn){const selector=typeof target==='string' ? target:'#app';if(!this.listeners.has(selector)){this.listeners.set(selector,[]);}this.listeners.get(selector).push(fn);}async cleanup(target='#app'){if(this.listeners.has(target)){for(const cleanup of this.listeners.get(target)){await cleanup();}this.listeners.delete(target);}document.dispatchEvent(new CustomEvent('bunz:cleanup',{detail:{target}}));}}window.bunzLifecycle=new BunzLifecycle();console.log('✅ BUNZ Lifecycle initialized');class BunzScripts{loadedScripts=new Set();async execute(html,container){const tempDiv=document.createElement('div');tempDiv.innerHTML=html;const scripts=tempDiv.querySelectorAll('script');const el=typeof container==='string' ? document.querySelector(container):container;for(const oldScript of scripts){await this.executeScript(oldScript,el);}this.autoLoadComponentScript(html);}async executeScript(oldScript,container){const newScript=document.createElement('script');Array.from(oldScript.attributes).forEach(attr=>{newScript.setAttribute(attr.name,attr.value);});if(oldScript.src){if(this.loadedScripts.has(oldScript.src)){return;}return new Promise((resolve,reject)=>{newScript.onload=()=>{this.loadedScripts.add(oldScript.src);resolve();};newScript.onerror=reject;document.head.appendChild(newScript);});}else{newScript.textContent=oldScript.textContent;container.appendChild(newScript);}}autoLoadComponentScript(html){return;}clearCache(){this.loadedScripts.clear();}}window.bunzScripts=new BunzScripts();console.log('✅ BUNZ Scripts initialized');class BunzCore{cache=new Map();async load(path,target){const el=typeof target==='string' ? document.querySelector(target):target;if(!el)return console.error('Target not found:',target);try{const html=await this.fetch(path);el.innerHTML=html;if(window.bunzScripts){await window.bunzScripts.execute(html,el);}document.dispatchEvent(new CustomEvent('bunz:loaded',{detail:{component:path}}));}catch(e){console.error('Load error:',e);}}async fetch(path){const url=path.startsWith('/htx/')? path:`/htx/${path}`;if(this.cache.has(url))return this.cache.get(url);const res=await fetch(url);if(!res.ok)throw new Error(`HTTP ${res.status}`);const html=await res.text();this.cache.set(url,html);return html;}}window.bunzCore=new BunzCore();window.loadComponent=(c,t)=>bunzCore.load(c,t);console.log('✅ BUNZ Core initialized');class BunzLoader{loaded=new Set();loading=new Map();modulePaths={'scripts':'/js/core/scripts.js','state':'/js/core/state.js','cache':'/js/core/cache.js','modal':'/js/ui/modal.js','toast':'/js/ui/toast.js','cookies':'/js/ui/cookies.js','a11y':'/js/ui/a11y.js','errors':'/js/utils/errors.js','forms':'/js/utils/forms.js','templates':'/js/modules/templates.js','components':'/js/modules/components.js','i18n':'/js/modules/i18n.js','webrtc':'/js/modules/webrtc.js','map':'/js/modules/map.js','canvas':'/js/modules/canvas.js','realtime':'/js/modules/realtime.js',};async load(moduleName){if(this.loaded.has(moduleName)){return Promise.resolve();}if(this.loading.has(moduleName)){return this.loading.get(moduleName);}const promise=this.loadScript(moduleName);this.loading.set(moduleName,promise);try{await promise;this.loaded.add(moduleName);this.loading.delete(moduleName);console.log(`✅ Lazy-loaded:${moduleName}`);}catch(error){console.error(`❌ Failed to load:${moduleName}`,error);this.loading.delete(moduleName);throw error;}return promise;}loadScript(moduleName){return new Promise((resolve,reject)=>{const script=document.createElement('script');script.src=this.modulePaths[moduleName]||`/js/modules/${moduleName}.js`;script.defer=true;script.onload=resolve;script.onerror=reject;document.head.appendChild(script);});}isLoaded(moduleName){return this.loaded.has(moduleName);}async loadAll(moduleNames){return Promise.all(moduleNames.map(name=>this.load(name)));}}window.bunzLoader=new BunzLoader();console.log('✅ BUNZ Loader initialized(lazy-loading enabled)');document.addEventListener('DOMContentLoaded',()=>{requestIdleCallback(()=>{bunzLoader.load('scripts');if(document.getElementById('bunz-modal')){bunzLoader.load('modal');}bunzLoader.load('toast');if(!localStorage.getItem('cookie-consent')){bunzLoader.load('cookies');}bunzLoader.load('a11y');if(document.querySelector('form')){bunzLoader.load('forms');}},{timeout:1000});});document.addEventListener('bunz:loaded',()=>{const needsTemplates=document.querySelector('.video-container,.room-page-container,.meeting-page');if(needsTemplates&&!window.bunzTemplates){bunzLoader.load('templates');}});class BunzLifecycle{listeners=new Map();async beforeSwap(target,url){const event=new CustomEvent('bunz:beforeSwap',{detail:{target,url},cancelable:true});document.dispatchEvent(event);if(this.listeners.has(target)){for(const cleanup of this.listeners.get(target)){await cleanup();}this.listeners.delete(target);}return!event.defaultPrevented;}afterSwap(target,url,html){document.dispatchEvent(new CustomEvent('bunz:afterSwap',{detail:{target,url,html}}));}onCleanup(target,fn){const selector=typeof target==='string' ? target:'#app';if(!this.listeners.has(selector)){this.listeners.set(selector,[]);}this.listeners.get(selector).push(fn);}async cleanup(target='#app'){if(this.listeners.has(target)){for(const cleanup of this.listeners.get(target)){await cleanup();}this.listeners.delete(target);}document.dispatchEvent(new CustomEvent('bunz:cleanup',{detail:{target}}));}}window.bunzLifecycle=new BunzLifecycle();console.log('✅ BUNZ Lifecycle initialized');class BunzCore{cache=new Map();async load(path,target){const el=typeof target==='string' ? document.querySelector(target):target;if(!el)return console.error('Target not found:',target);try{el.innerHTML=await this.fetch(path);document.dispatchEvent(new CustomEvent('bunz:loaded',{detail:{component:path}}));}catch(e){console.error('Load error:',e);}}async fetch(path){const url=path.startsWith('/htx/')? path:`/htx/${path}`;if(this.cache.has(url))return this.cache.get(url);const res=await fetch(url);if(!res.ok)throw new Error(`HTTP ${res.status}`);const html=await res.text();this.cache.set(url,html);return html;}}window.bunzCore=new BunzCore();window.loadComponent=(c,t)=>bunzCore.load(c,t);console.log('✅ BUNZ Core initialized');(function(){'use strict';const config={authEndpoint:'/api/me',loginModal:'/htx/pages/login.htx',defaultTarget:'#app'};const guards={auth:async()=>{const res=await fetch(config.authEndpoint,{credentials:'include'});if(!res.ok&&window.openModal){await window.openModal(config.loginModal);return false;}return res.ok;},guest:async()=>{const res=await fetch(config.authEndpoint,{credentials:'include'});if(res.ok){await load('/htx/pages/dashboard.htx','#app');return false;}return true;}};async function load(url,target,pushState=true){try{const targetEl=document.querySelector(target||config.defaultTarget);if(!targetEl)return;if(pushState&&url.includes('.htx')){let route=url.replace('/htx/pages/','/').replace('.htx','');if(route==='/index')route='/';if(window.location.pathname===route){console.log('Already on this page,skipping reload');return;}}const isPrerendered=targetEl.getAttribute('data-prerendered')==='true';if(isPrerendered&&!pushState){console.log('✅ Using pre-rendered SSR content');targetEl.removeAttribute('data-prerendered');if(window.bunzScripts){const html=targetEl.innerHTML;await window.bunzScripts.execute(html,targetEl);}if(window.bunzA11y){window.bunzA11y.manageFocus(targetEl);window.bunzA11y.announce('Page loaded');}if(url.includes('.htx')){let route=url.replace('/htx/pages/','/').replace('.htx','');if(route==='/index')route='/';window.history.replaceState({url,target},'',route);}if(window.bunzLifecycle){window.bunzLifecycle.afterSwap(target,url,targetEl.innerHTML);}document.dispatchEvent(new CustomEvent('bz:loaded',{detail:{url,target,prerendered:true}}));return;}if(window.bunzLifecycle){const proceed=await window.bunzLifecycle.beforeSwap(target,url);if(!proceed)return;}if(window.bunzState){window.bunzState.preserveElements(targetEl);}targetEl.classList.add('fade-out');await new Promise(r=>setTimeout(r,100));let html;try{if(window.bunzCache){html=await window.bunzCache.fetch(url);}else{const res=await fetch(url);if(!res.ok)throw new Error(`HTTP ${res.status}`);html=await res.text();}}catch(error){if(window.bunzErrors){return window.bunzErrors.handle(error,url,targetEl,{pushState});}throw error;}targetEl.innerHTML=html;if(window.bunzState){window.bunzState.restoreElements(targetEl);}if(window.bunzScripts){await window.bunzScripts.execute(html,targetEl);}targetEl.classList.remove('fade-out');targetEl.classList.add('fade-in');setTimeout(()=>targetEl.classList.remove('fade-in'),100);if(window.bunzA11y){window.bunzA11y.manageFocus(targetEl);window.bunzA11y.announce('Page loaded');}if(pushState&&url.includes('.htx')){let route=url.replace('/htx/pages/','/').replace('.htx','');if(route==='/index')route='/';window.history.pushState({url,target},'',route);}if(window.bunzLifecycle){window.bunzLifecycle.afterSwap(target,url,html);}document.dispatchEvent(new CustomEvent('bz:loaded',{detail:{url,target}}));}catch(err){console.error('BUNZ Load Error:',err);if(window.bunzErrors){window.bunzErrors.handle(err,url,target,{pushState});}}}document.addEventListener('click',async(e)=>{const el=e.target.closest('[bz-get],a[href*=".htx"]');if(!el)return;e.preventDefault();let url,target;if(el.hasAttribute('bz-get')){url=el.getAttribute('bz-get');target=el.getAttribute('bz-target');}else{const href=el.getAttribute('href');const [path,hash]=href.split('#');url=path;target=hash ? `#${hash}`:null;}const guard=el.getAttribute('bz-guard');if(guard&&guards[guard]){const passed=await guards[guard]();if(!passed)return;}await load(url,target);});document.addEventListener('submit',async(e)=>{const form=e.target.closest('[bz-post]');if(!form)return;e.preventDefault();const url=form.getAttribute('bz-post');const target=form.getAttribute('bz-target');if(window.bunzForms){const{valid,errors}=window.bunzForms.validate(form);if(!valid){console.error('Form validation errors:',errors);return;}}const formData=new FormData(form);try{const res=await fetch(url,{method:'POST',body:formData,credentials:'include'});const html=await res.text();const targetEl=document.querySelector(target||config.defaultTarget);if(targetEl){targetEl.innerHTML=html;if(window.bunzScripts){await window.bunzScripts.execute(html,targetEl);}}document.dispatchEvent(new CustomEvent('bz:submitted',{detail:{url,target}}));}catch(err){console.error('BUNZ Post Error:',err);}});window.addEventListener('popstate',async(e)=>{if(e.state&&e.state.url){await load(e.state.url,e.state.target,false);}});function getHTXPath(pathname){if(pathname==='/')return '/htx/pages/index.htx';const segments=pathname.split('/').filter(Boolean);if(segments.length>1){return `/htx/pages/${segments[0]}.htx`;}return `/htx/pages${pathname}.htx`;}document.addEventListener('DOMContentLoaded',()=>{const path=window.location.pathname;const htxFile=getHTXPath(path);fetch(htxFile,{method:'HEAD'}).then(res=>res.ok ? load(htxFile,config.defaultTarget,false):null).catch(()=>load('/htx/pages/index.htx',config.defaultTarget,false));});window.bunz={load,guards,config};console.log('✅ BUNZ initialized(full-featured)');})();