name: BUNZ Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Initialize database
        run: bun run db:init || echo "Database might already be initialized"
      
      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium
      
      - name: Run API tests
        run: bun test tests/api
      
      - name: Run E2E tests
        run: bunx playwright test
      
      - name: Run Lighthouse audit
        run: bun run tests/performance/lighthouse.test.ts
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: test-results/playwright-report/
          retention-days: 30
      
      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: lighthouse-report.json
          retention-days: 30
      
      - name: Upload State of the Bunz report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: state-of-the-bunz
          path: test-results/state-of-the-bunz.*
          retention-days: 30
      
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('test-results/state-of-the-bunz.json', 'utf8'));
            
            const body = `## üöÄ State of the Bunz
            
            **Status**: ${report.passed ? '‚úÖ PASSED' : '‚ùå FAILED'}
            **Duration**: ${(report.duration / 1000).toFixed(2)}s
            
            ### Test Suites
            ${report.suites.map(s => `- ${s.passed ? '‚úÖ' : '‚ùå'} ${s.name}: ${s.passed ? 'PASSED' : 'FAILED'} (${(s.duration / 1000).toFixed(2)}s)`).join('\n')}
            
            [View full report](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

